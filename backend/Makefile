# mobileorder backend Makefile

.PHONY: test test-controllers test-services test-repositories test-validators test-coverage test-integration clean help setup-mockdata

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
all: test

# mockDataã®å†æŒ¿å…¥ï¼ˆDocker DBç”¨ï¼‰
setup-mockdata:
	@echo "ğŸ—„ï¸  Docker DBã«mockDataã‚’æŒ¿å…¥..."
	@if ! docker compose ps | grep -q "postgres-db.*Up"; then \
		echo "âŒ Docker Compose DBãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚'docker compose up -d' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@cat mockData.sql | docker compose exec -T db psql -U myuser -d mydb
	@echo "âœ… mockDataæŒ¿å…¥å®Œäº†"

# å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’é †æ¬¡å®Ÿè¡Œ
test:
	@echo "=== mobileorder ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ==="
	@$(MAKE) clean
	@$(MAKE) test-validators
	@$(MAKE) test-controllers
	@$(MAKE) test-services
	@$(MAKE) test-repositories
	@$(MAKE) test-coverage
	@echo "=== ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº† ==="

# ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼å±¤ã®ãƒ†ã‚¹ãƒˆ
test-validators:
	@echo "ğŸ§ª ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼å±¤ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	@mkdir -p coverage
	go test ./validators -v -coverprofile=coverage/validators.out -covermode=atomic
	@echo "âœ… ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼å±¤: å®Œäº†"

# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å±¤ã®ãƒ†ã‚¹ãƒˆ
test-controllers:
	@echo "ğŸ§ª ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å±¤ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	@mkdir -p coverage
	go test ./controllers -v -coverprofile=coverage/controllers.out -covermode=atomic
	@echo "âœ… ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å±¤: å®Œäº†"

# ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®å…¨ãƒ†ã‚¹ãƒˆï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆ+çµåˆï¼‰
test-services:
	@echo "ğŸ§ª ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	@mkdir -p coverage
	@echo "ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«mockDataã‚’æŒ¿å…¥ä¸­..."
	@$(MAKE) setup-mockdata > /dev/null 2>&1 || echo "âš ï¸  mockDataæŒ¿å…¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆDockeræœªèµ·å‹•ã¾ãŸã¯DBã‚¨ãƒ©ãƒ¼ï¼‰"
	@export DATABASE_URL="postgres://myuser:mypassword@localhost:5432/mydb?sslmode=disable" && \
	go test ./services -v -coverprofile=coverage/services.out -covermode=atomic
	@echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹å±¤: å®Œäº†"

# ãƒªãƒã‚¸ãƒˆãƒªå±¤ã®ãƒ†ã‚¹ãƒˆ
test-repositories:
	@echo "ğŸ§ª ãƒªãƒã‚¸ãƒˆãƒªå±¤ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	@mkdir -p coverage
	@echo "ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«mockDataã‚’æŒ¿å…¥ä¸­..."
	@$(MAKE) setup-mockdata > /dev/null 2>&1 || echo "âš ï¸  mockDataæŒ¿å…¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆDockeræœªèµ·å‹•ã¾ãŸã¯DBã‚¨ãƒ©ãƒ¼ï¼‰"
	@export DATABASE_URL="postgres://myuser:mypassword@localhost:5432/mydb?sslmode=disable" && \
	go test ./repositories -v -coverprofile=coverage/repositories.out -covermode=atomic
	@echo "âœ… ãƒªãƒã‚¸ãƒˆãƒªå±¤: å®Œäº†"

# ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
test-coverage:
	@echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ..."
	@mkdir -p coverage
	@echo "mode: atomic" > coverage/combined.out
	@if [ -f coverage/validators.out ]; then tail -n +2 coverage/validators.out >> coverage/combined.out; fi
	@if [ -f coverage/controllers.out ]; then tail -n +2 coverage/controllers.out >> coverage/combined.out; fi
	@if [ -f coverage/services.out ]; then tail -n +2 coverage/services.out >> coverage/combined.out; fi
	@if [ -f coverage/repositories.out ]; then tail -n +2 coverage/repositories.out >> coverage/combined.out; fi
	go tool cover -html=coverage/combined.out -o coverage/report.html
	@echo "ğŸ“ HTMLãƒ¬ãƒãƒ¼ãƒˆ: coverage/report.html"
	@echo "ğŸ“Š å…¨ä½“ã®ã‚«ãƒãƒ¬ãƒƒã‚¸:"
	@go tool cover -func=coverage/combined.out | tail -1

# ã‚«ãƒãƒ¬ãƒƒã‚¸çµæœã®ã¿è¡¨ç¤º
coverage-summary:
	@if [ -f coverage/combined.out ]; then \
		echo "ğŸ“Š å…¨ä½“ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼:"; \
		go tool cover -func=coverage/combined.out | tail -1; \
	else \
		echo "âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã« 'make test' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
	fi

# çµ±åˆãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
test-integration:
	@echo "ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	@echo "ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«mockDataã‚’æŒ¿å…¥ä¸­..."
	@$(MAKE) setup-mockdata > /dev/null 2>&1 || echo "âš ï¸  mockDataæŒ¿å…¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆDockeræœªèµ·å‹•ã¾ãŸã¯DBã‚¨ãƒ©ãƒ¼ï¼‰"
	@export DATABASE_URL="postgres://myuser:mypassword@localhost:5432/mydb?sslmode=disable" && \
	echo "ğŸ”— ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šURL: $$DATABASE_URL" && \
	go test -run="Integration" ./services -v
	@echo "âœ… çµ±åˆãƒ†ã‚¹ãƒˆ: å®Œäº†"

# ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean:
	@echo "ğŸ§¹ ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—..."
	rm -rf coverage/
	rm -f c.out coverage.html *_coverage.out

# ãƒ˜ãƒ«ãƒ—
help:
	@echo "ä½¿ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo "  make test              - å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’é †æ¬¡å®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰"
	@echo "  make setup-mockdata    - Docker DBã«mockDataã‚’å†æŒ¿å…¥"
	@echo "  make test-validators   - ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼å±¤ã®ã¿ãƒ†ã‚¹ãƒˆ"
	@echo "  make test-controllers  - ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å±¤ã®ã¿ãƒ†ã‚¹ãƒˆ"
	@echo "  make test-services     - ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®ã¿ãƒ†ã‚¹ãƒˆ"
	@echo "  make test-repositories - ãƒªãƒã‚¸ãƒˆãƒªå±¤ã®ã¿ãƒ†ã‚¹ãƒˆ"
	@echo "  make test-integration  - çµ±åˆãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ"
	@echo "  make test-coverage     - ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
	@echo "  make coverage-summary  - ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼è¡¨ç¤º"
	@echo "  make clean             - ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
	@echo "  make help              - ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
